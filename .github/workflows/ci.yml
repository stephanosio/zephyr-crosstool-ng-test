name: CI

on:
  push:
    branches: [ test_master ]
  pull_request:
    branches: [ test_master ]
  release:
    types: [ published ]

jobs:
  build:
    name: ${{ matrix.target }} (${{ matrix.host.name }})
    runs-on: ${{ matrix.host.build }}

    strategy:
      fail-fast: false
      matrix:
        host:
        - name: linux-x86_64
          build: ubuntu-18.04
        - name: macos-x86_64
          build: macos-10.15
        - name: windows-x86_64
          build: ubuntu-18.04
        target:
        - aarch64-zephyr-elf

    steps:
    # Check out source code
    - name: Check out source code
      uses: actions/checkout@v2

    # Fetch all history for all tags and branches
    - run: git fetch --prune --unshallow

    # Build toolchain
    - name: Build ${{ matrix.target }} toolchain for ${{ matrix.host.name }}
      run: |
        echo "DUMMY FILE" > ${HOME}/${{ matrix.target }}.tar.gz

    # Upload build artifact (on push and pull_request)
    - name: Upload build artifact
      if: github.event_name != 'release'
      uses: actions/upload-artifact@v2
      with:
        name: toolchain_${{ matrix.host.name }}_${{ matrix.target }}
        path: ~/${{ matrix.target }}.tar.gz

    # Upload release asset (on release)
    - name: Upload release asset
      if: github.event_name == 'release'
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: ~/${{ matrix.target }}.tar.gz
        asset_name: ${{ github.event.release.tag_name }}_${{ matrix.host.name }}_${{ matrix.target }}.tar.gz
        asset_content_type: application/gzip
